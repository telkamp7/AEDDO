\printbibliography[heading=bibintoc,title={Bibliography}]
\cleardoublepage 
\appendix

\chapter{Some probability functions}

This chapter serves as a reference, specifying notation, properties, and moments related to the various distributions used in this master thesis.

\begin{table}[h!]
\centering
  \resizebox{\textwidth}{!}{\begin{tabular}{m{0.12\textwidth}m{0.2\textwidth}m{0.50\textwidth}m{0.09\textwidth}m{0.09\textwidth}}
    \toprule
    Name & Support & Density & $\E[Y]$ & $\V[Y]$ \\
    \midrule
    Poisson \newline $\Pois(\lambda)$ & $0, 1, 2,\dots$ \newline $\lambda \in \mathbb{R}_{+}$ & $\frac{\lambda^{y}}{y!}\exp(-\lambda)$ & $\lambda$ & $\lambda$ \\
    \midrule
    Gamma \newline $\G(\alpha,\beta)$ & $\mathbb{R_{+}}$ \newline $\alpha \in \mathbb{R}_{+}, \beta \in \mathbb{R}_{+}$ & $\frac{1}{\Gamma(\alpha)\beta}\Big(\frac{y}{\beta}\Big)^{\alpha-1}\exp(-y/\beta)$ & $\alpha\beta$ & $\alpha\beta^2$ \\
    \midrule
    Neg. Bin. \newline $\NB(r,p)$ & $0, 1, 2,\dots$ \newline $r\in\mathbb{R}_+, p \in]0,1]$ & $\begin{pmatrix} r+y-1 \\ y \end{pmatrix} p^r(1-p)^y$ & $\frac{r(1+p)}{p}$ & $\frac{r(1-p)}{p^2}$ \\
    \midrule
    Normal \newline $\N(\mu, \sigma^2)$ & $\mathbb{R}$ \newline $\mu\in\mathbb{R}, \sigma^2\in\mathbb{R}_+$ & $\frac{1}{\sigma\sqrt{2\pi}}\exp\Big(-\frac{(y-\mu)^2}{2\sigma^2}\Big)$ & $\mu$ & $\sigma^2$ \\
    \bottomrule
  \end{tabular}}
  \caption{Density, support, mean value, and variance for a number of distributions used in this master thesis.}
  \label{table:probabilityFunctions}
\end{table}


\chapter{C++ templates for the negative joint log-likelihood}\label{cpp}

This chapter presents the user templates for the hierarchical Poisson Normal model in \eqref{eq:PoisN} and the hierarachical Poisson Gamma model in \eqref{eq:PoisGam}.

The user template for the hierarchical Poisson Normal model specified in \eqref{eq:PoisN} is

```{Rcpp, eval=FALSE}
#include <TMB.hpp>
template<class Type>
Type objective_function<Type>::operator() ()
{
  // R input data
  DATA_VECTOR(y);                               // Count data
  DATA_VECTOR(x);                               // Population size
  DATA_MATRIX(X);                               // Design matrix
  PARAMETER_VECTOR(u);                          // Random effects
  // Parameters
  PARAMETER_VECTOR(beta);                       // Fixed effects parameters
  PARAMETER(log_sigma_u);                       // Model parameter
  vector<Type> lambda  = exp(X*beta-log(x)+u);  // Construct 'lambda'
  Type sigma_u = exp(log_sigma_u);              // And the model parameters
  Type mean_ran = Type(0);
  // Objective function
  Type f = 0;                                   // Declare the objective
  f -= sum(dnorm(u,mean_ran,sigma_u,true));     // Calculate the objective
  f -= sum(dpois(y,lambda,true));               // Calculate the objective
  return f;
}
```

The user template for the hierarchical Poisson Gamma model specified in \eqref{eq:PoisGam} is

```{Rcpp, eval=FALSE}
#include <TMB.hpp>
template<class Type>
Type objective_function<Type>::operator() ()
{
  // Data
  DATA_VECTOR(y);                             // Count data
  DATA_VECTOR(x);                             // Population size
  DATA_MATRIX(X);                             // Design matrix
  // Parameters
  PARAMETER_VECTOR(beta);                     // Fixed effects parameters
  PARAMETER(log_phi_u);                       // Model parameter
  vector<Type> lambda  = exp(X*beta-log(x));  // Construct 'lambda'
  Type phi_u = exp(log_phi_u);                // And the model parameters
  Type r = 1/phi_u;                           // Construct the size
  vector<Type> p = 1/(lambda*phi_u+1);        // And the prob. parameter
  // Objective function
  Type f = -sum(dnbinom(y, r, p,true));       // Calculate the objective
  return f;
}
```

\chapter{State-of-the-art detection algorithm}

\section{Controls}\label{controlsStateOfTheArt}

In the function `farringtonFlexible`, users can select either the original Farrington method or the improved method by Noufaily by specifying the appropriate `control` arguments. The choice of algorithm variant is determined by the contents of the `control` slot. In the example provided, `con.farrington` indicates the use of the original method, while `con.noufaily` represents the options for the improved method.

```{r ControlsLIST, eval=FALSE}

con.farrington <- list(
  range = NULL, b = 3, w = 2,
  reweight = TRUE, weightsThreshold = 1,
  verbose = TRUE, glmWarnings = TRUE,
  alpha = 0.05, trend = TRUE, pThresholdTrend = 0.05,
  limit54 = c(0,4), powertrans = "2/3",
  fitFun = "algo.farrington.fitGLM.flexible",
  populationOffset = TRUE,
  noPeriods = 1, pastWooksNotIncluded = NULL,
  thersholdMethod = "delta"
)

con.noufaily <- list(
  range = NULL, b = 3, w = 2,
  reweight = TRUE, weightsThreshold = 2.58,
  verbose = TRUE, glmWarnings = TRUE,
  alpha = 0.05, trend = TRUE, pThresholdTrend = 0.05,
  limit54 = c(0,4), powertrans = "2/3",
  fitFun = "algo.farrington.fitGLM.flexible",
  populationOffset = TRUE,
  noPeriods = 1, pastWooksNotIncluded = NULL,
  thersholdMethod = "Noufaily"
)

```


In this chapter an excerpt of the results


```{r LISTStateOfTheArtTbl, echo=FALSE}

LIST_alarms_StateOfTheArt %>%
  select(Date, ageGroup, method, y, threshold, alarm) %>%
  pivot_wider(names_from = method, values_from = c(threshold, alarm)) %>%
  select(Date, `Age group` = ageGroup, `$y_t$` = y, Treshold.1 = threshold_Farrington, Alarm.1 = alarm_Farrington, Threshold.2 = threshold_Noufaily, Alarm.2 = alarm_Noufaily) %>%
  kbl(booktabs = TRUE,
      longtable = TRUE,
      escape = FALSE,
      caption = "Longtable",
      col.names = gsub("\\.\\d", "", names(.))) %>%
  kable_paper(latex_options = c("repeat_header"),  repeat_header_method = c("replace")) %>%
  add_header_above(c(" " = 3, "Farrington" = 2, "Noufaily" = 2)) %>%
  column_spec(1, bold = TRUE) %>%
  collapse_rows(columns = 1)

```

```{r SHIGStateOfTheArtTbl, echo=FALSE, eval=FALSE}

SHIG_alarms_StateOfTheArt %>%
  select(Date, ageGroup, method, y, threshold, alarm) %>%
  pivot_wider(names_from = method, values_from = c(threshold, alarm)) %>%
  select(Date, `Age group` = ageGroup, `$y_t$` = y, Treshold.1 = threshold_Farrington, Alarm.1 = alarm_Farrington, Threshold.2 = threshold_Noufaily, Alarm.2 = alarm_Noufaily) %>%
  kbl(booktabs = TRUE,
      longtable = TRUE,
      escape = FALSE,
      caption = "Longtable",
      col.names = gsub("\\.\\d", "", names(.))) %>%
  kable_paper(latex_options = c("repeat_header"),  repeat_header_method = c("replace")) %>%
  add_header_above(c(" " = 3, "Farrington" = 2, "Noufaily" = 2)) %>%
  column_spec(1, bold = TRUE) %>%
  collapse_rows(columns = 1)

```

```{r STECStateOfTheArtTbl, echo=FALSE, eval=FALSE}

STEC_alarms_StateOfTheArt %>%
  select(Date, ageGroup, method, y, threshold, alarm) %>%
  pivot_wider(names_from = method, values_from = c(threshold, alarm)) %>%
  select(Date, `Age group` = ageGroup, `$y_t$` = y, Treshold.1 = threshold_Farrington, Alarm.1 = alarm_Farrington, Threshold.2 = threshold_Noufaily, Alarm.2 = alarm_Noufaily) %>%
  kbl(booktabs = TRUE,
      longtable = TRUE,
      escape = FALSE,
      caption = "Longtable",
      col.names = gsub("\\.\\d", "", names(.))) %>%
  kable_paper(latex_options = c("repeat_header"),  repeat_header_method = c("replace")) %>%
  add_header_above(c(" " = 3, "Farrington" = 2, "Noufaily" = 2)) %>%
  column_spec(1, bold = TRUE) %>%
  collapse_rows(columns = 1)

```

```{r SALMStateOfTheArtTbl, echo=FALSE, eval=FALSE}

SALM_alarms_StateOfTheArt %>%
  select(Date, ageGroup, method, y, threshold, alarm) %>%
  pivot_wider(names_from = method, values_from = c(threshold, alarm)) %>%
  select(Date, `Age group` = ageGroup, `$y_t$` = y, Treshold.1 = threshold_Farrington, Alarm.1 = alarm_Farrington, Threshold.2 = threshold_Noufaily, Alarm.2 = alarm_Noufaily) %>%
  kbl(booktabs = TRUE,
      longtable = TRUE,
      escape = FALSE,
      caption = "Longtable",
      col.names = gsub("\\.\\d", "", names(.))) %>%
  kable_paper(latex_options = c("repeat_header"),  repeat_header_method = c("replace")) %>%
  add_header_above(c(" " = 3, "Farrington" = 2, "Noufaily" = 2)) %>%
  column_spec(1, bold = TRUE) %>%
  collapse_rows(columns = 1)

```


\chapter{Figures and Tables related to the case studies}\label{FigAndTabCaseStudy}


\section{\textit{Listeriosis}}

```{r LISTNovelTblAppendix, echo=FALSE}

LIST_novel_tbl %>%
  mutate(`Estimate (95\\% CI)` = paste0(round(theta,2), " (",round(CI.lwr,2),", ",round(CI.upr,2),")"),
         Model = case_when(
           grepl(pattern = "PoisN_", x = method) ~ "Poisson Normal",
           grepl(pattern = "PoisG_", x = method) ~ "Poisson Gamma"
           ),
         Formula = gsub(pattern = "PoisN_|PoisG_", replacement = "", x = method),
         Parameter = case_when(
           Parameter == "ageGroup<1 year" ~ "$\\beta_{<1 year}$",
           Parameter == "ageGroup1-4 years" ~ "$\\beta_{1-4 years}$",
           Parameter == "ageGroup5-14 years" ~ "$\\beta_{5-14 years}$",
           Parameter == "ageGroup15-24 years" ~ "$\\beta_{15-24 years}$",
           Parameter == "ageGroup25-64 years" ~ "$\\beta_{25-64 years}$",
           Parameter == "ageGroup<65 years" ~ "$\\beta_{<65 years}$",
           Parameter == "ageGroup65+ years" ~ "$\\beta_{65+ years}$",
           Parameter == "t" ~ "$\\beta_{trend}$",
           Parameter == "log_sigma" ~ "$\\log(\\sigma)$",
           Parameter == "log_phi" ~ "$\\log(\\phi)$",
           Parameter == "sin(pi/6 * monthInYear)" ~ "$\\beta_{\\sin}$",
           Parameter == "cos(pi/6 * monthInYear)" ~ "$\\beta_{\\cos}$"
         )) %>%
  # mutate(Formula = gsub(pattern = "_", replacement = "", x = Formula)) %>%
  mutate(Formula = case_when(
    Formula == "ageGroup" ~ "\\begin{math}\\log(\\lambda_{it})=\\beta(ageGroup_{i})+\\log(n_{it})\\end{math}",
    Formula == "ageGroup_trend" ~ "\\begin{math}\\log(\\lambda_{it})=\\beta(ageGroup_{i})+\\beta_{trend} t +\\log(n_{it})\\end{math}",
    Formula == "ageGroup_seasonality" ~ "\\begin{math}\\log(\\lambda_{it})=\\beta(ageGroup_{i})+\\beta_{\\sin}\\sin\\Big(\\frac{\\pi\\cdot monthInYear_{t}}{6}\\Big) + \\beta_{\\cos} \\cos\\Big(\\frac{\\pi \\cdot monthInYear_{t}}{6}\\Big)+\\log(n_{it})\\end{math}",
    Formula == "ageGroup_trend_seasonality" ~ "\\begin{math}\\log(\\lambda_{it})=\\beta(ageGroup_{i})+\\beta_{trend} t + \\beta_{\\sin} \\sin\\Big(\\frac{\\pi\\cdot monthInYear_{t}}{6}\\Big) + \\beta_{\\cos} \\cos\\Big(\\frac{\\pi \\cdot monthInYear_{t}}{6}\\Big)+\\log(n_{it})\\end{math}"
  )) %>%
  select(Model, Formula, `$\\bar{S}(G,y)$` = avgLogS, Parameter, `Estimate (95\\% CI)`) %>%
  kbl(booktabs = TRUE, escape = FALSE, longtable = TRUE, caption = "The average logarithmic score, $\\bar{S}(G,y)$, along with the parameter estimates at $t_{0}$ for a suite of models modelling \\textit{Listeriosis}, assuming either the hierarchical Poisson Normal model or the hierarchical Poisson Gamma model.  The confidence intervals for the estimates are calculated using profile likelihood confidence intervals.") %>%
  kable_paper(latex_options = c("repeat_header", "HOLD_position"), repeat_header_method = c("replace")) %>%
  collapse_rows(columns = 1:3, 
                row_group_label_position = "stack",
                row_group_label_fonts = row_group_label_fonts,
                latex_hline = "custom",
                custom_latex_hline = 1:3)

```

\section{\textit{Shigellosis}}

```{r SHIGNovelTblAppendix, echo=FALSE}

SHIG_novel_tbl %>%
  mutate(`Estimate (95\\% CI)` = paste0(round(theta,2), " (",round(CI.lwr,2),", ",round(CI.upr,2),")"),
         Model = case_when(
           grepl(pattern = "PoisN_", x = method) ~ "Poisson Normal",
           grepl(pattern = "PoisG_", x = method) ~ "Poisson Gamma"
           ),
         Formula = gsub(pattern = "PoisN_|PoisG_", replacement = "", x = method),
         Parameter = case_when(
           Parameter == "ageGroup<25 years" ~ "$\\beta_{<25 years}$",
           Parameter == "ageGroup25+ years" ~ "$\\beta_{25+ years}$",
           Parameter == "t" ~ "$\\beta_{trend}$",
           Parameter == "log_sigma" ~ "$\\log(\\sigma)$",
           Parameter == "log_phi" ~ "$\\log(\\phi)$",
           Parameter == "sin(pi/6 * monthInYear)" ~ "$\\beta_{\\sin}$",
           Parameter == "cos(pi/6 * monthInYear)" ~ "$\\beta_{\\cos}$"
         )) %>%
  # mutate(Formula = gsub(pattern = "_", replacement = "", x = Formula)) %>%
  mutate(Formula = case_when(
    Formula == "ageGroup" ~ "\\begin{math}\\log(\\lambda_{it})=\\beta(ageGroup_{i})+\\log(n_{it})\\end{math}",
    Formula == "ageGroup_trend" ~ "\\begin{math}\\log(\\lambda_{it})=\\beta(ageGroup_{i})+\\beta_{trend} t +\\log(n_{it})\\end{math}",
    Formula == "ageGroup_seasonality" ~ "\\begin{math}\\log(\\lambda_{it})=\\beta(ageGroup_{i})+\\beta_{\\sin}\\sin\\Big(\\frac{\\pi\\cdot monthInYear_{t}}{6}\\Big) + \\beta_{\\cos} \\cos\\Big(\\frac{\\pi \\cdot monthInYear_{t}}{6}\\Big)+\\log(n_{it})\\end{math}",
    Formula == "ageGroup_trend_seasonality" ~ "\\begin{math}\\log(\\lambda_{it})=\\beta(ageGroup_{i})+\\beta_{trend} t + \\beta_{\\sin} \\sin\\Big(\\frac{\\pi\\cdot monthInYear_{t}}{6}\\Big) + \\beta_{\\cos} \\cos\\Big(\\frac{\\pi \\cdot monthInYear_{t}}{6}\\Big)+\\log(n_{it})\\end{math}"
  )) %>%
  select(Model, Formula, `$\\bar{S}(G,y)$` = avgLogS, Parameter, `Estimate (95\\% CI)`) %>%
  kbl(booktabs = TRUE, escape = FALSE, longtable = TRUE, caption = "The average logarithmic score, $\\bar{S}(G,y)$, along with the parameter estimates at $t_{0}$ for a suite of models modelling \\textit{Shigellosis}, assuming either the hierarchical Poisson Normal model or the hierarchical Poisson Gamma model.  The confidence intervals for the estimates are calculated using profile likelihood confidence intervals.") %>%
  kable_paper(latex_options = c("repeat_header", "HOLD_position"), repeat_header_method = c("replace")) %>%
  collapse_rows(columns = 1:3, 
                row_group_label_position = "stack",
                row_group_label_fonts = row_group_label_fonts,
                latex_hline = "custom",
                custom_latex_hline = 1:3)

```

\section{Shiga toxin (verotoxin)-producing \textit{Escherichia coli}}

```{r STECNovelTblAppendix, echo=FALSE}

STEC_novel_tbl %>%
  mutate(`Estimate (95\\% CI)` = paste0(round(theta,2), " (",round(CI.lwr,2),", ",round(CI.upr,2),")"),
         Model = case_when(
           grepl(pattern = "PoisN_", x = method) ~ "Poisson Normal",
           grepl(pattern = "PoisG_", x = method) ~ "Poisson Gamma"
           ),
         Formula = gsub(pattern = "PoisN_|PoisG_", replacement = "", x = method),
         Parameter = case_when(
           Parameter == "ageGroup<1 year" ~ "$\\beta_{<1 year}$",
           Parameter == "ageGroup1-4 years" ~ "$\\beta_{1-4 years}$",
           Parameter == "ageGroup5-14 years" ~ "$\\beta_{5-14 years}$",
           Parameter == "ageGroup15-24 years" ~ "$\\beta_{15-24 years}$",
           Parameter == "ageGroup25-64 years" ~ "$\\beta_{25-64 years}$",
           Parameter == "ageGroup<65 years" ~ "$\\beta_{<65 years}$",
           Parameter == "ageGroup65+ years" ~ "$\\beta_{65+ years}$",
           Parameter == "t" ~ "$\\beta_{trend}$",
           Parameter == "log_sigma" ~ "$\\log(\\sigma)$",
           Parameter == "log_phi" ~ "$\\log(\\phi)$",
           Parameter == "sin(pi/6 * monthInYear)" ~ "$\\beta_{\\sin}$",
           Parameter == "cos(pi/6 * monthInYear)" ~ "$\\beta_{\\cos}$"
         )) %>%
  # mutate(Formula = gsub(pattern = "_", replacement = "", x = Formula)) %>%
  mutate(Formula = case_when(
    Formula == "ageGroup" ~ "\\begin{math}\\log(\\lambda_{it})=\\beta(ageGroup_{i})+\\log(n_{it})\\end{math}",
    Formula == "ageGroup_trend" ~ "\\begin{math}\\log(\\lambda_{it})=\\beta(ageGroup_{i})+\\beta_{trend} t +\\log(n_{it})\\end{math}",
    Formula == "ageGroup_seasonality" ~ "\\begin{math}\\log(\\lambda_{it})=\\beta(ageGroup_{i})+\\beta_{\\sin}\\sin\\Big(\\frac{\\pi\\cdot monthInYear_{t}}{6}\\Big) + \\beta_{\\cos} \\cos\\Big(\\frac{\\pi \\cdot monthInYear_{t}}{6}\\Big)+\\log(n_{it})\\end{math}",
    Formula == "ageGroup_trend_seasonality" ~ "\\begin{math}\\log(\\lambda_{it})=\\beta(ageGroup_{i})+\\beta_{trend} t + \\beta_{\\sin} \\sin\\Big(\\frac{\\pi\\cdot monthInYear_{t}}{6}\\Big) + \\beta_{\\cos} \\cos\\Big(\\frac{\\pi \\cdot monthInYear_{t}}{6}\\Big)+\\log(n_{it})\\end{math}"
  )) %>%
  select(Model, Formula, `$\\bar{S}(G,y)$` = avgLogS, Parameter, `Estimate (95\\% CI)`) %>%
  kbl(booktabs = TRUE, escape = FALSE, longtable = TRUE, caption = "The average logarithmic score, $\\bar{S}(G,y)$, along with the parameter estimates at $t_{0}$ for a suite of models modelling Shiga toxin (verotoxin)-producing \\textit{Escherichia coli}, assuming either the hierarchical Poisson Normal model or the hierarchical Poisson Gamma model.  The confidence intervals for the estimates are calculated using profile likelihood confidence intervals.") %>%
  kable_paper(latex_options = c("repeat_header", "HOLD_position"), repeat_header_method = c("replace")) %>%
  collapse_rows(columns = 1:3, 
                row_group_label_position = "stack",
                row_group_label_fonts = row_group_label_fonts,
                latex_hline = "custom",
                custom_latex_hline = 1:3)

```

